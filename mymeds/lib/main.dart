import 'package:firebase_core/firebase_core.dart';
import 'package:flutter/material.dart';
import 'theme/app_theme.dart';
import 'routes/app_router.dart';
import 'services/user_session.dart';
import 'services/settings_service.dart';
// import 'utils/firebase_seeder.dart'; //for seeding uncomment
import 'firebase_options.dart'; // generated by FlutterFire CLI
import 'providers/motion_provider.dart';
import 'providers/settings_provider.dart';
import 'package:provider/provider.dart';
import 'ui/dialogs/mobile_data_prompt_dialog.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // ðŸŒ± SEEDING: Uncomment to seed database (run once then comment out)
  //await FirebaseSeeder().seedAll();

  // Initialize user session management
  await UserSession().init();

  // Initialize settings service
  await SettingsService().init();

  runApp(
     MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) {
          final motionProvider = MotionProvider();
          motionProvider.start();
          return motionProvider;
        }),
        ChangeNotifierProvider(create: (_) {
          final settingsProvider = SettingsProvider();
          settingsProvider.init();
          return settingsProvider;
        }),
      ],
      child: const MyMedsApp(),
    ),
  );
}

class MyMedsApp extends StatefulWidget {
  const MyMedsApp({super.key});

  @override
  State<MyMedsApp> createState() => _MyMedsAppState();
}

class _MyMedsAppState extends State<MyMedsApp> {
  @override
  void initState() {
    super.initState();
    
    // Listen for mobile data prompt from SettingsProvider
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _setupMobileDataListener();
    });
  }

  /// Setup listener for mobile data detection
  void _setupMobileDataListener() {
    final settingsProvider = context.read<SettingsProvider>();
    settingsProvider.addListener(_checkMobileDataPrompt);
    
    // Initial check in case prompt was triggered during init
    _checkMobileDataPrompt();
  }

  /// Check if mobile data prompt should be shown
  void _checkMobileDataPrompt() {
    if (!mounted) return;
    
    final settingsProvider = context.read<SettingsProvider>();
    
    if (settingsProvider.showMobileDataPrompt) {
      _showMobileDataPromptDialog();
    }
  }

  /// Show the mobile data prompt dialog
  void _showMobileDataPromptDialog() {
    if (!mounted) return;
    
    final settingsProvider = context.read<SettingsProvider>();
    
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => MobileDataPromptDialog(
        onEnableDataSaver: () async {
          if (mounted) {
            await settingsProvider.enableDataSaverFromPrompt();
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('âœ… Data Saver Mode enabled successfully!'),
                duration: Duration(seconds: 2),
                backgroundColor: Colors.green,
              ),
            );
          }
        },
        onDecline: () async {
          if (mounted) {
            await settingsProvider.declineMobileDataPrompt();
          }
        },
        onDontAskAgain: () async {
          if (mounted) {
            await settingsProvider.dontAskAgainMobileDataPrompt();
          }
        },
      ),
    ).whenComplete(() {
      // Reset state after dialog closes
      if (mounted) {
        settingsProvider.removeListener(_checkMobileDataPrompt);
        _setupMobileDataListener();
      }
    });
  }

  @override
  void dispose() {
    try {
      context.read<SettingsProvider>().removeListener(_checkMobileDataPrompt);
    } catch (e) {
      debugPrint('Error removing listener: $e');
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'MyMeds',
      theme: AppTheme.lightTheme,
      initialRoute: AppRouter.login,
      onGenerateRoute: AppRouter.generateRoute,
      debugShowCheckedModeBanner: false,
    );
  }
}
